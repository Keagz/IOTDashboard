<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Device Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e27;
            --bg-card: #151b3d;
            --accent-cyan: #00d9ff;
            --accent-green: #00ff88;
            --accent-orange: #ff6b35;
            --accent-red: #ff2e63;
            --accent-purple: #9d4edd;
            --accent-gray: #64748b;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --glow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        /* Authentication Screen */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .auth-screen.hidden {
            display: none;
        }

        .auth-box {
            background: var(--bg-card);
            border: 2px solid var(--accent-cyan);
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.6s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-box h1 {
            color: var(--accent-cyan);
            font-size: 2.5em;
            margin-bottom: 10px;
            font-family: 'Space Mono', monospace;
        }

        .auth-box p {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            background: var(--bg-dark);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1.1em;
            font-family: 'Space Mono', monospace;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        .auth-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.4);
        }

        .auth-error {
            background: rgba(255, 46, 99, 0.2);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
            display: none;
        }

        .auth-error.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .dashboard-container {
            display: none;
        }

        .dashboard-container.authenticated {
            display: block;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255, 46, 99, 0.2);
            border: 2px solid var(--accent-red);
            color: var(--accent-red);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            font-weight: 600;
            transition: all 0.3s;
            z-index: 1000;
        }

        .logout-btn:hover {
            background: var(--accent-red);
            color: white;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(157, 78, 221, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 217, 255, 0.1) 0%, transparent 50%);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
            animation: slideDown 0.8s ease-out;
        }

        .header h1 {
            font-family: 'Space Mono', monospace;
            font-size: 3.5em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            letter-spacing: -2px;
        }

        .subtitle {
            font-size: 1.1em;
            color: var(--text-secondary);
            font-weight: 300;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 40px;
            border: 1px solid rgba(0, 217, 255, 0.1);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pulse-dot {
            width: 10px;
            height: 10px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 0 10px var(--accent-green);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .last-update {
            font-family: 'Space Mono', monospace;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        /* Gauges Section */
        .gauges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .gauge-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .gauge-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--card-color), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .gauge-card:hover {
            transform: translateY(-5px);
            border-color: var(--card-color);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 20px var(--card-color);
        }

        .gauge-card:hover::before {
            opacity: 1;
        }

        .gauge-card.active {
            border-color: var(--card-color);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 30px var(--card-color);
            transform: translateY(-5px) scale(1.02);
        }

        .gauge-card.active::before {
            opacity: 1;
        }

        .gauge-card.installed { --card-color: var(--accent-green); }
        .gauge-card.transmitting { --card-color: var(--accent-cyan); }
        .gauge-card.not-transmitting { --card-color: var(--accent-orange); }
        .gauge-card.zeros { --card-color: var(--accent-red); }
        .gauge-card.not-installed { --card-color: var(--accent-gray); }
        .gauge-card.not-updated { --card-color: var(--accent-purple); }

        .gauge-visual {
            width: 140px;
            height: 140px;
            margin: 0 auto 20px;
            position: relative;
        }

        .gauge-svg {
            transform: rotate(-90deg);
            filter: drop-shadow(0 0 8px var(--card-color));
        }

        .gauge-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.05);
            stroke-width: 12;
        }

        .gauge-fill {
            fill: none;
            stroke: var(--card-color);
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gauge-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5em;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            color: var(--card-color);
        }

        .gauge-label {
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .gauge-percentage {
            font-size: 1.1em;
            color: var(--card-color);
            font-weight: 600;
            margin-top: 10px;
        }

        /* Device Table Section */
        .table-section {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            animation: fadeIn 1s ease-out 0.3s both;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-header h2 {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .device-count {
            font-family: 'Space Mono', monospace;
            font-size: 0.9em;
            color: var(--text-secondary);
            padding: 8px 16px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(0, 217, 255, 0.2);
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            border-radius: 10px;
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .device-table thead {
            position: sticky;
            top: 0;
            background: var(--bg-dark);
            z-index: 10;
        }

        .device-table th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.75em;
            color: var(--text-secondary);
            border-bottom: 2px solid rgba(0, 217, 255, 0.2);
        }

        .device-table td {
            padding: 18px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-family: 'Space Mono', monospace;
            font-size: 0.85em;
        }

        .device-table tbody tr {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .device-table tbody tr:hover {
            background: rgba(0, 217, 255, 0.05);
            transform: scale(1.01);
        }

        .sig-cell {
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.transmitting {
            background: rgba(0, 255, 136, 0.15);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .status-badge.false {
            background: rgba(255, 46, 99, 0.15);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .fw-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .fw-status.ok {
            color: var(--accent-green);
        }

        .fw-status.update {
            background: rgba(255, 107, 53, 0.15);
            color: var(--accent-orange);
            border: 1px solid var(--accent-orange);
        }

        .installed-status {
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .installed-status.removed {
            color: var(--accent-gray);
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2em;
            color: var(--text-secondary);
        }

        .error {
            background: rgba(255, 46, 99, 0.1);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .config-panel {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(0, 217, 255, 0.2);
        }

        .config-panel h3 {
            color: var(--accent-cyan);
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .config-panel input {
            width: 100%;
            padding: 15px;
            background: var(--bg-dark);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1em;
            font-family: 'Space Mono', monospace;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .config-panel input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
        }

        .config-panel button {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .config-panel button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.3);
        }

        .timestamp-cell {
            color: var(--text-secondary);
            font-size: 0.8em;
        }

        /* Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .gauges-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .table-wrapper {
                font-size: 0.85em;
            }
        }

        /* Modal Popup */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            border: 2px solid var(--accent-cyan);
            border-radius: 20px;
            padding: 40px;
            max-width: 1400px;
            width: 95%;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 217, 255, 0.3);
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(0, 217, 255, 0.3);
        }

        .modal-header h2 {
            font-size: 2em;
            color: var(--accent-cyan);
            font-family: 'Space Mono', monospace;
        }

        .close-btn {
            background: none;
            border: 2px solid var(--accent-red);
            color: var(--accent-red);
            font-size: 1.5em;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: var(--accent-red);
            color: white;
            transform: rotate(90deg);
        }

        .history-chart {
            background: var(--bg-dark);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            height: 250px;
        }

        .history-chart canvas {
            max-height: 200px;
        }

        .time-range-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
            align-items: center;
        }

        .time-range-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .time-range-btn:hover {
            background: rgba(0, 217, 255, 0.1);
            border-color: var(--accent-cyan);
        }

        .time-range-btn.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            color: var(--bg-dark);
            font-weight: 700;
        }

        .custom-range-container {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0, 217, 255, 0.05);
            border: 2px solid rgba(0, 217, 255, 0.2);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .custom-range-container label {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .custom-range-container input[type="datetime-local"] {
            padding: 8px 12px;
            background: var(--bg-dark);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.85em;
        }

        .custom-range-container button {
            padding: 8px 16px;
            background: var(--accent-cyan);
            border: none;
            border-radius: 6px;
            color: var(--bg-dark);
            font-weight: 700;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .custom-range-container button:hover {
            background: var(--accent-green);
            transform: translateY(-2px);
        }

        .loading-spinner {
            text-align: center;
            padding: 60px;
            font-size: 1.2em;
            color: var(--accent-cyan);
        }

        .loading-spinner::after {
            content: '‚ö°';
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-box">
            <h1>üîí</h1>
            <h1>IoT Monitor</h1>
            <p>Enter password to access dashboard</p>
            
            <div id="authError" class="auth-error">
                ‚ùå Incorrect password. Please try again.
            </div>
            
            <input type="password" 
                   id="passwordInput" 
                   class="auth-input" 
                   placeholder="Enter password"
                   onkeypress="if(event.key==='Enter') checkPassword()">
            
            <button class="auth-button" onclick="checkPassword()">
                üîì Unlock Dashboard
            </button>
        </div>
    </div>

    <!-- Logout Button -->
    <button id="logoutBtn" class="logout-btn" onclick="logout()" style="display: none;">
        üîí Logout
    </button>

    <!-- Main Dashboard (hidden until authenticated) -->
    <div id="dashboardContainer" class="dashboard-container">
    <div class="container">
        <div class="header">
            <h1 style="cursor: pointer;" onclick="clearAllFilters()">‚ö° IoT MONITOR</h1>
            <div class="subtitle">Real-time Device Telemetry Dashboard</div>
        </div>

        <div class="config-panel" id="configPanel" style="display: none;">
            <h3>üìã Configuration</h3>
            <input type="text" id="sheetUrl" placeholder="Enter Google Sheet URL" 
                   value="https://docs.google.com/spreadsheets/d/1nC-nLfFwI0zia3ItR5ljpPimfTdXGUSVPXUMEkbjEV4/edit?usp=sharing">
            <button onclick="saveConfig()">Connect Dashboard</button>
            <p style="margin-top: 15px; font-size: 0.85em; color: var(--text-secondary);">
                Ensure your Google Sheet is publicly accessible
            </p>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="pulse-dot"></div>
                <span>Live Connection</span>
            </div>
            <div class="last-update" id="lastUpdate">Initializing...</div>
        </div>

        <div id="loading" class="loading">üîÑ Loading telemetry data...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="dashboardContent" style="display: none;">
            <!-- Gauges Grid -->
            <div class="gauges-grid" id="gaugesGrid"></div>

            <!-- Device Table -->
            <div class="table-section">
                <div class="table-header">
                    <h2>üì° Device Status</h2>
                    <div class="device-count" id="deviceCount">0 Devices</div>
                </div>
                
                <div class="table-wrapper">
                    <table class="device-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>SIG</th>
                                <th>Software</th>
                                <th>Voltage</th>
                                <th>Current</th>
                                <th>Temp</th>
                                <th>SOC %</th>
                                <th>Cycles</th>
                                <th>CSQ</th>
                                <th>Transmitting</th>
                                <th>FW Status</th>
                                <th>Installed</th>
                            </tr>
                        </thead>
                        <tbody id="deviceTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- Close dashboard-container -->

    <!-- Historical Data Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalDeviceName">Device History</h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalBody">
                <div class="loading-spinner">Loading historical data</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // =====================================================
        // AUTHENTICATION SYSTEM
        // =====================================================
        
        // PASSWORD CONFIGURATION - CHANGE THIS!
        const DASHBOARD_PASSWORD = 'iot2024'; // Change this to your desired password
        
        // Check if already authenticated (session storage)
        function checkAuth() {
            const isAuthenticated = sessionStorage.getItem('iot_dashboard_auth') === 'true';
            
            if (isAuthenticated) {
                showDashboard();
            } else {
                showAuthScreen();
            }
        }
        
        // Verify password
        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const password = input.value;
            const errorDiv = document.getElementById('authError');
            
            if (password === DASHBOARD_PASSWORD) {
                // Correct password
                sessionStorage.setItem('iot_dashboard_auth', 'true');
                showDashboard();
                input.value = '';
                errorDiv.classList.remove('show');
            } else {
                // Wrong password
                errorDiv.classList.add('show');
                input.value = '';
                input.focus();
                
                // Shake animation and hide error after 3 seconds
                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 3000);
            }
        }
        
        // Show dashboard (hide auth screen)
        function showDashboard() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('dashboardContainer').classList.add('authenticated');
            document.getElementById('logoutBtn').style.display = 'block';
            
            // Load dashboard data
            loadData();
            startAutoRefresh();
        }
        
        // Show auth screen (hide dashboard)
        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('dashboardContainer').classList.remove('authenticated');
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('passwordInput').focus();
        }
        
        // Logout function
        function logout() {
            sessionStorage.removeItem('iot_dashboard_auth');
            showAuthScreen();
            
            // Stop auto-refresh
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
        }
        
        // =====================================================
        // DASHBOARD CODE
        // =====================================================
        
        const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes
        const SHEET_ID = '1nC-nLfFwI0zia3ItR5ljpPimfTdXGUSVPXUMEkbjEV4';
        let refreshTimer;
        let allDevices = []; // Store all devices for filtering

        // Create circular gauge
        function createGauge(value, max, color) {
            const percentage = (value / max) * 100;
            const circumference = 2 * Math.PI * 60;
            const offset = circumference - (percentage / 100) * circumference;
            
            return `
                <svg class="gauge-svg" width="140" height="140" viewBox="0 0 140 140">
                    <circle class="gauge-bg" cx="70" cy="70" r="60"/>
                    <circle class="gauge-fill" cx="70" cy="70" r="60"
                            style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};"/>
                </svg>
                <div class="gauge-value">${value}</div>
            `;
        }

        // Fetch data from Google Sheets using JSON API
        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';

                // Fetch JSON data from the Summary sheet
                const SUMMARY_SHEET_GID = '941941150';
                const apiUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SUMMARY_SHEET_GID}`;
                
                console.log('üîç Fetching from SUMMARY SHEET (gid=' + SUMMARY_SHEET_GID + ')');
                console.log('üìç Full URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Cannot access sheet`);
                }
                
                const text = await response.text();
                console.log('Received data, length:', text.length);
                
                // Parse Google's JSON format (wrapped in a function call)
                const json = JSON.parse(text.substring(47).slice(0, -2));
                console.log('Parsed JSON, rows:', json.table.rows.length);
                console.log('‚ö†Ô∏è IMPORTANT: First row timestamp should be recent (Dec 2025), not old (Nov 2025)');
                
                const rows = json.table.rows;
                
                if (rows.length === 0) {
                    throw new Error('No data found in sheet');
                }

                // Find summary data and device rows
                let summaryData = null;
                let deviceRows = [];

                console.log('Processing rows...');
                
                // Get summary data from the FIRST row
                // O1=14, Q1=16, S1=18, U1=20, W1=22, Y1=24 (0-indexed)
                const firstRow = rows[0].c;
                summaryData = {
                    totalInstalled: firstRow[14]?.v || 0,        // Column O
                    transmittingSuccessfully: firstRow[16]?.v || 0,  // Column Q
                    notTransmitting: firstRow[18]?.v || 0,       // Column S
                    transmittingZeros: firstRow[20]?.v || 0,     // Column U
                    notInstalled: firstRow[22]?.v || 0,          // Column W
                    notUpdated: firstRow[24]?.v || 0             // Column Y
                };
                console.log('Summary data from row 1:', summaryData);
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i].c;
                    
                    // Skip if no SIG column data
                    if (!row[1] || !row[1].v) continue;
                    
                    const sig = row[1].v;
                    
                    // Collect device rows (rows with SIG data containing REET or TEST)
                    if (typeof sig === 'string' && (sig.includes('REET') || sig.includes('TEST'))) {
                        
                        // Debug first device to see structure
                        if (deviceRows.length === 0) {
                            console.log('First device row structure:', {
                                timestamp: row[0],
                                sig: row[1],
                                software: row[2],
                                voltage: row[3],
                                current: row[4],
                                temp: row[5],
                                soc: row[6],
                                cycles: row[7],
                                csq: row[8],
                                transmitting: row[9],
                                fwStatus: row[10],
                                installed: row[11]
                            });
                        }
                        
                        const device = {
                            timestamp: row[0]?.f || row[0]?.v || '',
                            sig: row[1]?.v || '',
                            software: row[2]?.v || '',
                            voltage: row[3]?.v !== null && row[3]?.v !== undefined ? parseFloat(row[3].v) : 0,
                            current: row[4]?.v !== null && row[4]?.v !== undefined ? parseFloat(row[4].v) : 0,
                            temperature: row[5]?.v !== null && row[5]?.v !== undefined ? parseFloat(row[5].v) : 0,
                            soc: row[6]?.v !== null && row[6]?.v !== undefined ? parseFloat(row[6].v) : 0,
                            cycles: row[7]?.v !== null && row[7]?.v !== undefined ? parseInt(row[7].v) : 0,
                            csq: row[8]?.v !== null && row[8]?.v !== undefined ? parseInt(row[8].v) : 0,
                            transmitting: row[9]?.v === true || row[9]?.v === 'TRUE' || row[9]?.v === 'true',
                            fwStatus: row[10]?.v || '',
                            installed: row[11]?.v || ''
                        };
                        
                        deviceRows.push(device);
                        
                        // Log first 3 parsed devices
                        if (deviceRows.length <= 3) {
                            console.log(`Parsed device ${deviceRows.length}:`, device);
                        }
                    }
                }

                console.log('Found devices:', deviceRows.length);

                // Sort devices by SIG numeric part only (ignore TEST/REET prefix)
                deviceRows.sort((a, b) => {
                    // Extract numeric part from SIG (e.g., "REET0003" -> 3, "TEST0001" -> 1)
                    const getNumericPart = (sig) => {
                        const match = sig.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    };
                    
                    const numA = getNumericPart(a.sig);
                    const numB = getNumericPart(b.sig);
                    
                    return numA - numB;
                });

                console.log('First device after sorting by number:', deviceRows[0]);
                console.log('Last device after sorting by number:', deviceRows[deviceRows.length - 1]);

                // Store devices globally for filtering
                allDevices = deviceRows;

                displayGauges(summaryData);
                applyFilters(); // Apply filters and display
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                document.getElementById('lastUpdate').textContent = 
                    `Last Updated: ${new Date().toLocaleTimeString()}`;
                document.getElementById('deviceCount').textContent = 
                    `${deviceRows.length} Devices`;

            } catch (error) {
                console.error('Full error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = 
                    `‚ùå <strong>Error:</strong> ${error.message}<br><br>
                    <small>Check browser console (F12) for detailed logs</small>`;
            }
        }

        // Display gauge cards
        function displayGauges(data) {
            const total = data.totalInstalled + data.notInstalled;
            
            const gauges = [
                {
                    label: 'Total Installed',
                    value: data.totalInstalled,
                    max: total,
                    percentage: `${((data.totalInstalled / total) * 100).toFixed(1)}%`,
                    class: 'installed',
                    filterType: 'installed'
                },
                {
                    label: 'Transmitting OK',
                    value: data.transmittingSuccessfully,
                    max: data.totalInstalled,
                    percentage: `${((data.transmittingSuccessfully / data.totalInstalled) * 100).toFixed(1)}%`,
                    class: 'transmitting',
                    filterType: 'transmitting-ok'
                },
                {
                    label: 'Not Transmitting',
                    value: data.notTransmitting,
                    max: data.totalInstalled,
                    percentage: `${((data.notTransmitting / data.totalInstalled) * 100).toFixed(1)}%`,
                    class: 'not-transmitting',
                    filterType: 'not-transmitting'
                },
                {
                    label: 'Transmitting Zero\'s',
                    value: data.transmittingZeros,
                    max: data.totalInstalled,
                    percentage: `${((data.transmittingZeros / data.totalInstalled) * 100).toFixed(1)}%`,
                    class: 'zeros',
                    filterType: 'transmitting-zeros'
                },
                {
                    label: 'Not Installed',
                    value: data.notInstalled,
                    max: total,
                    percentage: `${((data.notInstalled / total) * 100).toFixed(1)}%`,
                    class: 'not-installed',
                    filterType: 'not-installed'
                },
                {
                    label: 'Not Updated',
                    value: data.notUpdated,
                    max: data.totalInstalled,
                    percentage: `${((data.notUpdated / data.totalInstalled) * 100).toFixed(1)}%`,
                    class: 'not-updated',
                    filterType: 'not-updated'
                }
            ];

            const grid = document.getElementById('gaugesGrid');
            grid.innerHTML = gauges.map(gauge => `
                <div class="gauge-card ${gauge.class}" onclick="filterByCard('${gauge.filterType}')" id="card-${gauge.filterType}">
                    <div class="gauge-label">${gauge.label}</div>
                    <div class="gauge-visual">
                        ${createGauge(gauge.value, gauge.max)}
                    </div>
                    <div class="gauge-percentage">${gauge.percentage}</div>
                </div>
            `).join('');
        }

        // Display device table
        function displayDeviceTable(devices) {
            const tbody = document.getElementById('deviceTableBody');
            
            if (devices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 40px;">No device data found</td></tr>';
                return;
            }
            
            tbody.innerHTML = devices.map(device => {
                // Helper to format numbers
                const formatValue = (val, decimals, unit) => {
                    if (val === null || val === undefined) return '-';
                    return val.toFixed(decimals) + unit;
                };
                
                return `
                <tr onclick="showDeviceHistory('${device.sig}')">
                    <td class="timestamp-cell">${device.timestamp || '-'}</td>
                    <td class="sig-cell">${device.sig || '-'}</td>
                    <td>${device.software || '-'}</td>
                    <td>${device.voltage !== null && device.voltage !== undefined ? formatValue(device.voltage, 1, 'V') : '-'}</td>
                    <td>${device.current !== null && device.current !== undefined ? formatValue(device.current, 1, 'A') : '-'}</td>
                    <td>${device.temperature !== null && device.temperature !== undefined ? formatValue(device.temperature, 0, '¬∞C') : '-'}</td>
                    <td>${device.soc !== null && device.soc !== undefined ? formatValue(device.soc, 1, '%') : '-'}</td>
                    <td>${device.cycles !== null && device.cycles !== undefined && device.cycles !== 0 ? device.cycles : '-'}</td>
                    <td>${device.csq !== null && device.csq !== undefined && device.csq !== 0 ? device.csq : '-'}</td>
                    <td>
                        <span class="status-badge ${device.transmitting ? 'transmitting' : 'false'}">
                            ${device.transmitting ? '‚úì TRUE' : '‚úó FALSE'}
                        </span>
                    </td>
                    <td>
                        <span class="fw-status ${device.fwStatus === 'OK' ? 'ok' : 'update'}">
                            ${device.fwStatus || '-'}
                        </span>
                    </td>
                    <td class="installed-status ${device.installed !== 'Installed' ? 'removed' : ''}">
                        ${device.installed || '-'}
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Auto-refresh
        function startAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(loadData, REFRESH_INTERVAL);
        }

        // Initialize
        window.addEventListener('load', () => {
            // Check authentication first
            checkAuth();
        });
        
        let activeFilter = null;
        let currentDevice = null; // Track current device in modal
        let activeTimeRange = '1d'; // Default to 1 day
        
        // Clear all filters and reload
        function clearAllFilters() {
            activeFilter = null;
            clearActiveCards();
            applyFilters();
        }
        
        // Filter by card click
        function filterByCard(filterType) {
            // Toggle filter - if clicking the same card, clear filter
            if (activeFilter === filterType) {
                activeFilter = null;
                clearActiveCards();
                applyFilters();
                return;
            }
            
            activeFilter = filterType;
            
            // Update visual state of cards
            clearActiveCards();
            const card = document.getElementById(`card-${filterType}`);
            if (card) {
                card.classList.add('active');
            }
            
            applyFilters();
        }
        
        // Clear active state from all cards
        function clearActiveCards() {
            document.querySelectorAll('.gauge-card').forEach(card => {
                card.classList.remove('active');
            });
        }
        
        // Apply filters to device list
        function applyFilters() {
            let filteredDevices = [...allDevices];
            
            if (activeFilter) {
                switch(activeFilter) {
                    case 'installed':
                        // Show only installed devices
                        filteredDevices = filteredDevices.filter(device => 
                            device.installed === 'Installed'
                        );
                        break;
                        
                    case 'transmitting-ok':
                        // Show devices transmitting successfully (TRUE and not zeros)
                        filteredDevices = filteredDevices.filter(device => 
                            device.transmitting === true && 
                            !(device.voltage === 0 && device.current === 0 && device.soc === 0)
                        );
                        break;
                        
                    case 'not-transmitting':
                        // Show devices not transmitting (FALSE) but only if installed
                        filteredDevices = filteredDevices.filter(device => 
                            device.transmitting === false && 
                            device.installed === 'Installed'
                        );
                        break;
                        
                    case 'transmitting-zeros':
                        // Show devices transmitting but all zeros
                        filteredDevices = filteredDevices.filter(device => 
                            device.transmitting === true && 
                            device.voltage === 0 && device.current === 0 && device.soc === 0
                        );
                        break;
                        
                    case 'not-installed':
                        // Show devices not installed (Removed status)
                        filteredDevices = filteredDevices.filter(device => 
                            device.installed !== 'Installed'
                        );
                        break;
                        
                    case 'not-updated':
                        // Show devices with Update FW status
                        filteredDevices = filteredDevices.filter(device => 
                            device.fwStatus === 'Update'
                        );
                        break;
                }
            }
            
            displayDeviceTable(filteredDevices);
            
            // Update device count
            if (activeFilter) {
                document.getElementById('deviceCount').textContent = 
                    `${filteredDevices.length} of ${allDevices.length} Devices`;
            } else {
                document.getElementById('deviceCount').textContent = 
                    `${allDevices.length} Devices`;
            }
        }
        
        // =====================================================
        // SECURE INFLUXDB INTEGRATION - Via Apps Script Proxy
        // =====================================================
        
        // Apps Script proxy URL - UPDATE THIS WITH YOUR DEPLOYMENT URL
        const PROXY_URL = 'YOUR_APPS_SCRIPT_WEB_APP_URL_HERE';
        // Example: 'https://script.google.com/macros/s/AKfycbx.../exec'
        
        // Fetch historical data via secure proxy
        async function fetchInfluxData(deviceSig, timeRange = '1d', customFrom = null, customTo = null) {
            try {
                // Build query URL
                let url = `${PROXY_URL}?action=queryHistory&sig=${encodeURIComponent(deviceSig)}&range=${timeRange}`;
                
                if (timeRange === 'custom' && customFrom && customTo) {
                    url += `&from=${encodeURIComponent(customFrom)}&to=${encodeURIComponent(customTo)}`;
                }
                
                console.log('Fetching from proxy:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Proxy request failed: ${response.status} ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                
                // Check if response is JSON (error) or CSV (success)
                if (contentType && contentType.includes('application/json')) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Unknown error from proxy');
                }
                
                const csvData = await response.text();
                
                if (!csvData || csvData.trim().length === 0) {
                    throw new Error('No data returned from proxy');
                }
                
                return parseInfluxCSV(csvData);
                
            } catch (error) {
                console.error('Proxy fetch error:', error);
                throw error;
            }
        }
        
        // Parse InfluxDB CSV response
        function parseInfluxCSV(csv) {
            const lines = csv.trim().split('\n');
            const data = {
                voltage: [],
                current: [],
                soc: [],
                temperature: [],
                timestamps: []
            };
            
            // Skip header rows (InfluxDB returns annotations first)
            let dataStartIndex = 0;
            for (let i = 0; i < lines.length; i++) {
                if (!lines[i].startsWith('#') && !lines[i].startsWith(',result,')) {
                    dataStartIndex = i;
                    break;
                }
            }
            
            // Parse data rows
            for (let i = dataStartIndex; i < lines.length; i++) {
                const line = lines[i];
                if (!line || line.startsWith('#')) continue;
                
                const cols = line.split(',');
                if (cols.length < 7) continue;
                
                const timestamp = cols[5]; // _time column
                const field = cols[7];     // _field column
                const value = parseFloat(cols[6]); // _value column
                
                if (!timestamp || isNaN(value)) continue;
                
                const date = new Date(timestamp);
                
                if (field === 'voltage') {
                    data.voltage.push({ time: date, value: value });
                } else if (field === 'current') {
                    data.current.push({ time: date, value: value });
                } else if (field === 'soc') {
                    data.soc.push({ time: date, value: value });
                } else if (field === 'temperature') {
                    data.temperature.push({ time: date, value: value });
                }
            }
            
            // Extract unique timestamps
            const allTimes = new Set();
            [...data.voltage, ...data.current, ...data.soc, ...data.temperature].forEach(d => {
                allTimes.add(d.time.getTime());
            });
            data.timestamps = Array.from(allTimes).sort().map(t => new Date(t));
            
            return data;
        }
        
        // Show device history modal
        async function showDeviceHistory(deviceSig) {
            currentDevice = deviceSig;
            const modal = document.getElementById('historyModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalDeviceName');
            
            // Show modal with loading state
            modal.classList.add('show');
            modalTitle.textContent = `üìä ${deviceSig} - Historical Data`;
            modalBody.innerHTML = '<div class="loading-spinner">Loading historical data from InfluxDB</div>';
            
            try {
                console.log('Attempting to fetch data for:', deviceSig, 'with range:', activeTimeRange);
                
                // Fetch data from InfluxDB with current time range
                const historicalData = await fetchInfluxData(deviceSig, activeTimeRange);
                
                console.log('Data received:', historicalData);
                
                // Display the data
                displayHistoricalData(historicalData, deviceSig, modalBody);
                
            } catch (error) {
                console.error('Full error object:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--accent-red);">
                        <h3>‚ùå Error Loading Data</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p style="margin-top: 20px; color: var(--text-secondary); font-size: 0.9em;">
                            Check browser console (F12) for detailed logs
                        </p>
                        <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; text-align: left; font-family: monospace; font-size: 0.8em;">
                            <strong>Debugging info:</strong><br>
                            Device: ${deviceSig}<br>
                            Range: ${activeTimeRange}<br>
                            Proxy URL: ${PROXY_URL}<br>
                            <br>
                            <strong>Troubleshooting:</strong><br>
                            1. Check if proxy URL is correct<br>
                            2. Verify Apps Script deployment is public<br>
                            3. Test proxy URL directly in browser<br>
                            4. Check Apps Script logs for errors
                        </div>
                    </div>
                `;
            }
        }
        
        // Display historical data with charts
        function displayHistoricalData(data, deviceSig, container) {
            if (!data.timestamps || data.timestamps.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <h3>üì≠ No Historical Data</h3>
                        <p>No data found for ${deviceSig} in the selected time range</p>
                    </div>
                `;
                return;
            }
            
            const timeRangeLabels = {
                '1h': 'Last Hour',
                '6h': 'Last 6 Hours',
                '1d': 'Last 24 Hours',
                '1w': 'Last 7 Days',
                'custom': 'Custom Range'
            };
            
            // Get default values for custom range (last 24 hours to now)
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            const formatDateTime = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            container.innerHTML = `
                <div class="time-range-selector">
                    <button class="time-range-btn ${activeTimeRange === '1h' ? 'active' : ''}" onclick="changeTimeRange('1h')">
                        ‚è±Ô∏è 1 Hour
                    </button>
                    <button class="time-range-btn ${activeTimeRange === '6h' ? 'active' : ''}" onclick="changeTimeRange('6h')">
                        ‚è∞ 6 Hours
                    </button>
                    <button class="time-range-btn ${activeTimeRange === '1d' ? 'active' : ''}" onclick="changeTimeRange('1d')">
                        üìÖ 1 Day
                    </button>
                    <button class="time-range-btn ${activeTimeRange === '1w' ? 'active' : ''}" onclick="changeTimeRange('1w')">
                        üìÜ 1 Week
                    </button>
                </div>
                
                <div class="custom-range-container">
                    <label>üìÜ Custom Range:</label>
                    <label style="font-size: 0.75em;">From:</label>
                    <input type="datetime-local" id="customFromDate" value="${formatDateTime(yesterday)}">
                    <label style="font-size: 0.75em;">To:</label>
                    <input type="datetime-local" id="customToDate" value="${formatDateTime(now)}">
                    <button onclick="applyCustomRange()">Apply</button>
                </div>
                
                <div style="margin-bottom: 25px; padding: 15px; background: rgba(0, 217, 255, 0.05); border-radius: 10px; border: 1px solid rgba(0, 217, 255, 0.2);">
                    <div style="color: var(--text-secondary); font-size: 0.9em;">
                        <strong style="color: var(--accent-cyan);">Time Range:</strong> ${timeRangeLabels[activeTimeRange]}<br>
                        <strong style="color: var(--accent-cyan);">From:</strong> ${data.timestamps[0].toLocaleString()}<br>
                        <strong style="color: var(--accent-cyan);">To:</strong> ${data.timestamps[data.timestamps.length - 1].toLocaleString()}<br>
                        <strong style="color: var(--accent-cyan);">Data Points:</strong> ${data.timestamps.length} readings
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                    <div class="history-chart">
                        <h3 style="color: var(--accent-green); margin-bottom: 10px; font-size: 1.1em;">‚ö° Voltage</h3>
                        <canvas id="voltageChart"></canvas>
                    </div>
                    
                    <div class="history-chart">
                        <h3 style="color: var(--accent-purple); margin-bottom: 10px; font-size: 1.1em;">‚ö° Current</h3>
                        <canvas id="currentChart"></canvas>
                    </div>
                    
                    <div class="history-chart">
                        <h3 style="color: var(--accent-cyan); margin-bottom: 10px; font-size: 1.1em;">üîã State of Charge</h3>
                        <canvas id="socChart"></canvas>
                    </div>
                    
                    <div class="history-chart">
                        <h3 style="color: var(--accent-orange); margin-bottom: 10px; font-size: 1.1em;">üå°Ô∏è Temperature</h3>
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>
            `;
            
            // Create charts
            createChart('voltageChart', 'Voltage (V)', data.voltage, 'rgba(0, 255, 136, 1)', 'rgba(0, 255, 136, 0.1)');
            createChart('currentChart', 'Current (A)', data.current, 'rgba(157, 78, 221, 1)', 'rgba(157, 78, 221, 0.1)');
            createChart('socChart', 'State of Charge (%)', data.soc, 'rgba(0, 217, 255, 1)', 'rgba(0, 217, 255, 0.1)');
            createChart('tempChart', 'Temperature (¬∞C)', data.temperature, 'rgba(255, 107, 53, 1)', 'rgba(255, 107, 53, 0.1)');
        }
        
        // Create Chart.js chart
        function createChart(canvasId, label, data, borderColor, backgroundColor) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.time.toLocaleString()),
                    datasets: [{
                        label: label,
                        data: data.map(d => d.value),
                        borderColor: borderColor,
                        backgroundColor: backgroundColor,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: borderColor,
                            bodyColor: '#fff',
                            borderColor: borderColor,
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#94a3b8',
                                maxRotation: 45,
                                minRotation: 45,
                                maxTicksLimit: 8
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#94a3b8'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        }
                    }
                }
            });
        }
        
        // Change time range and reload data
        async function changeTimeRange(timeRange) {
            if (!currentDevice) return;
            
            activeTimeRange = timeRange;
            await showDeviceHistory(currentDevice);
        }
        
        // Apply custom date range
        async function applyCustomRange() {
            if (!currentDevice) return;
            
            const fromInput = document.getElementById('customFromDate');
            const toInput = document.getElementById('customToDate');
            
            if (!fromInput || !toInput) return;
            
            const fromDate = fromInput.value;
            const toDate = toInput.value;
            
            if (!fromDate || !toDate) {
                alert('Please select both From and To dates');
                return;
            }
            
            const fromTime = new Date(fromDate);
            const toTime = new Date(toDate);
            
            if (fromTime >= toTime) {
                alert('From date must be before To date');
                return;
            }
            
            if (toTime > new Date()) {
                alert('To date cannot be in the future');
                return;
            }
            
            // Show loading
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = '<div class="loading-spinner">Loading custom range data from InfluxDB</div>';
            
            try {
                activeTimeRange = 'custom';
                const historicalData = await fetchInfluxData(currentDevice, 'custom', fromDate, toDate);
                displayHistoricalData(historicalData, currentDevice, modalBody);
            } catch (error) {
                console.error('Error fetching custom range:', error);
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--accent-red);">
                        <h3>‚ùå Error Loading Data</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('historyModal').classList.remove('show');
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
